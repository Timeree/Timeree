<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>æŒ‰å¯†ç è§£å‹å‹ç¼©åŒ…å¹¶æ˜¾ç¤ºæŒ‡å®šè·¯å¾„æ–‡ä»¶å†…å®¹</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif; margin: 24px; line-height: 1.6; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    label { display: block; margin: 12px 0 6px; font-weight: 600; }
    input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
    button { margin-top: 14px; padding: 10px 14px; border: none; border-radius: 6px; background: #2c7be5; color: #fff; font-weight: 600; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .status { margin-top: 12px; color: #555; }
    .error { color: #c62828; white-space: pre-wrap; }
    .output { margin-top: 16px; padding: 12px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; white-space: pre-wrap; word-break: break-word; }
    .mono  { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <h1>ğŸ“¦ è§£å‹å¹¶æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶å†…å®¹</h1>

  <label for="url">å‹ç¼©åŒ…ç›´é“¾ URLï¼ˆæ”¯æŒ .zipï¼‰</label>
  <input id="url" type="url" placeholder="ä¾‹å¦‚ï¼šhttps://example.com/archive.zip" />

  <label for="password">è§£å‹å¯†ç ï¼ˆå¦‚ä¸éœ€è¦å¯ç•™ç©ºï¼‰</label>
  <input id="password" type="text" placeholder="ä¾‹å¦‚ï¼š123456 æˆ–ç•™ç©º" />

  <label for="path">ç›®æ ‡æ–‡ä»¶è·¯å¾„ï¼ˆåŒºåˆ†å¤§å°å†™ï¼Œä½¿ç”¨å‹ç¼©åŒ…å†…çš„å®Œæ•´ç›¸å¯¹è·¯å¾„ï¼‰</label>
  <input id="path" type="text" placeholder="ä¾‹å¦‚ï¼šdocs/readme.txt æˆ– index.html" />

  <button id="run">æå–å¹¶æ˜¾ç¤º</button>

  <div class="status mono" id="status">çŠ¶æ€ï¼šç­‰å¾…è¾“å…¥â€¦</div>
  <div class="error mono" id="error"></div>
  <div class="output mono" id="output" aria-live="polite"></div>

  <!-- ä½¿ç”¨ ESM æ–¹å¼åŠ è½½ zip.jsï¼ˆæ”¯æŒåŠ å¯† ZIPï¼‰ -->
  <script type="module">
    import * as zip from "https://unpkg.com/@zip.js/zip.js/dist/zip.js";

    const $ = (id) => document.getElementById(id);
    const btn = $("run");
    const statusEl = $("status");
    const errorEl = $("error");
    const outputEl = $("output");

    function setStatus(text) {
      statusEl.textContent = "çŠ¶æ€ï¼š" + text;
    }
    function setError(text) {
      errorEl.textContent = text || "";
    }
    function setOutput(text) {
      outputEl.textContent = text || "";
    }

    async function fetchZipBlob(url) {
      // å¦‚é‡åˆ°è·¨åŸŸï¼ˆCORSï¼‰é™åˆ¶ï¼Œéœ€è¦ç¡®ä¿æœåŠ¡å™¨å…è®¸è·¨åŸŸæˆ–é€šè¿‡ä»£ç†è§£å†³
      const resp = await fetch(url, {
        mode: "cors",
        cache: "no-store",
      });
      if (!resp.ok) {
        throw new Error(`ä¸‹è½½å¤±è´¥ï¼šHTTP ${resp.status} ${resp.statusText}`);
      }
      const contentType = resp.headers.get("content-type") || "";
      if (!contentType.includes("zip") && !url.toLowerCase().endsWith(".zip")) {
        // éä¸¥æ ¼æ ¡éªŒï¼Œä»…æç¤ºï¼›æŸäº›æœåŠ¡å™¨ä¸ä¼šæ­£ç¡®è®¾ç½® content-type
        console.warn("è­¦å‘Šï¼šcontent-type é zipï¼Œä»å°è¯•è§£æã€‚");
      }
      return await resp.blob();
    }

    async function extractFileFromZip(blob, password, targetPath) {
      // zip.js æ”¯æŒåŠ å¯† ZIPï¼ˆä¼ ç»Ÿ ZipCrypto ä¸ AESï¼‰ï¼Œé€šè¿‡ password é€‰é¡¹è§£å¯†
      const options = {};
      if (password && password.trim().length > 0) {
        options.password = password.trim();
      }

      // å»ºç«‹ ZipReaderï¼›å¯ä¼ å…¥ onprogress ä»¥æ˜¾ç¤ºè¿›åº¦
      const reader = new zip.ZipReader(new zip.BlobReader(blob), {
        // è¯»å– entries åˆ—è¡¨çš„è¿›åº¦ï¼ˆä¸ä¸€å®šæ‰€æœ‰æœåŠ¡å™¨éƒ½èƒ½ç²¾ç¡®ç»™å‡ºï¼‰
        onprogress: (progress, total) => {
          if (total && total > 0) {
            setStatus(`è§£æå‹ç¼©åŒ…ç›®å½•ä¸­â€¦ ${(progress / total * 100).toFixed(1)}%`);
          } else {
            setStatus(`è§£æå‹ç¼©åŒ…ç›®å½•ä¸­â€¦ ${progress} bytes`);
          }
        }
      });

      try {
        const entries = await reader.getEntries();
        if (!entries || entries.length === 0) {
          throw new Error("å‹ç¼©åŒ…ä¸ºç©ºæˆ–æ— æ³•è¯»å–å†…å®¹ã€‚");
        }

        // å½’ä¸€åŒ–æ¯”è¾ƒï¼šzip å†…é€šå¸¸ä½¿ç”¨æ­£æ–œæ 
        const normalize = (p) => p.replace(/\\/g, "/");
        const wanted = normalize(targetPath);

        // åœ¨ entries ä¸­æŸ¥æ‰¾ç›®æ ‡æ–‡ä»¶ï¼›å¿½ç•¥ç›®å½•é¡¹ï¼ˆdirectory === trueï¼‰
        const entry = entries.find(e => !e.directory && normalize(e.filename) === wanted);
        if (!entry) {
          // æ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼ˆå›é€€ï¼‰ï¼šå°è¯•å¤§å°å†™æ•æ„Ÿå¤±è´¥åï¼Œæç¤ºæœ€æ¥è¿‘çš„è·¯å¾„
          const candidates = entries
            .filter(e => !e.directory)
            .map(e => e.filename);
          throw new Error(
            "æœªæ‰¾åˆ°ç›®æ ‡æ–‡ä»¶ï¼š" + wanted +
            (candidates.length ? "\nå¯ç”¨æ–‡ä»¶ç¤ºä¾‹ï¼š\n" + candidates.slice(0, 10).join("\n") + (candidates.length > 10 ? "\nâ€¦" : "") : "")
          );
        }

        // å°†æ–‡ä»¶ä»¥æ–‡æœ¬å½¢å¼è¯»å–ï¼ˆä¹Ÿå¯ä½¿ç”¨ Uint8ArrayWriter / BlobWriter å¤„ç†äºŒè¿›åˆ¶ï¼‰
        // è‹¥æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¦‚å›¾ç‰‡ï¼‰ï¼Œå»ºè®®æ”¹ç”¨ BlobWriter å†è½¬æˆ dataURL æ˜¾ç¤º
        const text = await entry.getData(new zip.TextWriter(), {
          onprogress: (progress, total) => {
            if (total && total > 0) {
              setStatus(`è¯»å–æ–‡ä»¶å†…å®¹ä¸­â€¦ ${(progress / total * 100).toFixed(1)}%`);
            } else {
              setStatus(`è¯»å–æ–‡ä»¶å†…å®¹ä¸­â€¦ ${progress} bytes`);
            }
          }
        });

        return text;
      } finally {
        await reader.close();
      }
    }

    btn.addEventListener("click", async () => {
      setError("");
      setOutput("");
      const url = $("url").value.trim();
      const password = $("password").value.trim();
      const targetPath = $("path").value.trim();

      if (!url) {
        setError("è¯·å¡«å†™å‹ç¼©åŒ…ç›´é“¾ URLã€‚");
        return;
      }
      if (!targetPath) {
        setError("è¯·å¡«å†™ç›®æ ‡æ–‡ä»¶è·¯å¾„ï¼ˆå‹ç¼©åŒ…å†…çš„ç›¸å¯¹è·¯å¾„ï¼‰ã€‚");
        return;
      }

      btn.disabled = true;
      setStatus("å¼€å§‹ä¸‹è½½å‹ç¼©åŒ…â€¦");

      try {
        const blob = await fetchZipBlob(url);
        setStatus("ä¸‹è½½å®Œæˆï¼Œå¼€å§‹è§£æä¸è§£å¯†â€¦");
        const text = await extractFileFromZip(blob, password, targetPath);
        setStatus("æå–å®Œæˆ âœ…");
        setOutput(text);
      } catch (err) {
        console.error(err);
        setStatus("å‡ºç°é”™è¯¯ âŒ");
        setError(String(err?.message || err));
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>